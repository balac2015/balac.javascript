//
   Created by yu869 on 2015/11/9.

extends ../layouts/default
block header
  link( rel="stylesheet" href="/plugins/datatables/dataTables.bootstrap.css")
//应用的page title
block pageTitle
  h1 洗衣价格待审核
    small 待审核系统中洗衣价格信息
block main
  .box
    .box-header.with-border
      h3.box-title 洗衣价格列表
      | &nbsp;
      a.btn.btn-xs.btn-default(href='/store/priceApplyList' title='查看待审核的洗衣价格')
        span 已审核

      | &nbsp;
      a.btn.btn-xs.btn-default(href='/store/refusePriceApplyList' title='查看已拒绝的洗衣价格')
        span 已拒绝

      | &nbsp;
      a#auditAll.btn.btn-xs.btn-default.pull-right(href='#' title='审核已选的洗衣价格')
        span 审核已选
    .panel-body
      form#priceAuditForm(method='post', style='display:none', action='/store/price/audit')
        input#ids(type='hidden',name='ids')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
      table#devicePriceApplyList.table.table-bordered.table-hover.table-striped(style="width:100%")
        thead
          th #
          th
            input.selectAll(type="checkbox" title="全选" id="selectAll")
          th 加盟商
          th 洗衣房
          th 设备名称
          th 洗衣程序
          th.text-right 基准价格
          th.text-right 设定价格
          th 状态
          th 申请人
          th 申请时间
          th 操作
        tbody

  #refuseModal.modal.fade(tabindex='-1', role='dialog', aria-labelledby='refuseModalLabel', aria-hidden='true')
    .modal-dialog
      .modal-content
        .container
          .modal-body
            .row.clearfix
              .col-md-12.column
                form#refuseForm.form-horizontal(action='/store/refuse',name='refuseForm',method='post')
                  input#id(type="hidden", name='id', value="")
                  input#_csrf(type='hidden', name='_csrf', value=_csrf)
                  #refuseReasonDiv.form-group.has-success
                    | &nbsp;&nbsp;&nbsp;
                    label(for='articleTitle') 拒绝原因:
                    input#reason.form-control(type='text',name='reason',placeholder='拒绝原因',style="width:30%",required)
                  .center-block
                    | &nbsp;&nbsp;&nbsp;
                    button.btn.btn-primary(type='button', data-dismiss='modal', aria-hidden='false') 取消
                    | &nbsp;&nbsp;&nbsp;
                    button.btn.btn-success(type="submit") 保存


//应用添加的脚本在scripts block中定义
block scripts
  script(src='/plugins/datatables/jquery.dataTables.min.js')
  script(src='/plugins/datatables/dataTables.bootstrap.min.js')
  script.
    $(document).ready(function () {

      $(".selectAll").on('click', function () {
        $("#devicePriceApplyList").find("tbody :checkbox").prop("checked", $(this).is(":checked"));
      });

      $("#auditAll").on('click', function() {
        var ids = [];
        $('#devicePriceApplyList input:checked').each(
                function (i, item) {
                  ids.push($(item).val());
                });

        $("#priceAuditForm #ids").val(ids);
        if (ids) {
          bootbox.confirm("是否对选定数据进行审核?", function (result) {
            if (result) {
              $("#priceAuditForm").submit();
            }
          });
        }
      })


      $('#devicePriceApplyList').dataTable({
        "language": {
          "url": "/plugins/datatables/Chinese.json"
        },
        select: true,
        searching: true,
        processing: true,
        serverSide: true,
        scrollX:true,
        ajax: {url: '/store/waitApplyDatatable'},
        rowid: '_id',
        columnDefs: [
          {targets: 0, visible: false, orderable: false, width: 80},
          {
            targets: 1,
            visible: true,
            orderable: false,
            render: function(data, type, row) {
              return '<input type="checkbox" name="ids" value="' + row._id + '">'
            }
          },
          {
            targets: 7,
            visible: true,
            orderable: false,
            width: 80,
            render: function (data, type, row) {
              var status = row.status;
              var msg = "";
              switch (status) {
                case '0':
                  msg = "待审核";
                  break;
                case '1':
                  msg = "已审核";
                  break;
                case '2':
                  msg = "审核未通过";
                  break;
              }
              return msg;
            }
          },
          {
            targets: -1,
            visible: true,
            orderable: false,
            width: 80,
            render: function (data, type, row) {
              var id = row._id;
              return "<button id='editrow' class='btn btn-default btn-xs' type='button' onclick=audit('" + id + "','" + row.status + "')><i class='fa fa-check'></i></button>"
                + "<button id='more' class='btn btn-default btn-xs' type='button' onclick=refuse('" + id + "','" + row.status + "')><i class='fa fa-close'></i></button>";
            }
          }
        ],
        columns: [
          {data: "_id"},
          {data: ""},
          {data: "franchiseeId.fullname", defaultContent: ''},
          {data: "storeId.name", defaultContent: ''},
          {data: "deviceId.name", defaultContent: ''},
          {data: "devicePriceId.type", defaultContent: ''},
          {data: "devicePriceId.price", defaultContent: '','class':'text-right',render: function ( data, type, full, meta ) {
            return data.toFixed(2) + " 元";
          }},
          {data: "price", defaultContent: '','class':'text-right',render: function ( data, type, full, meta ) {
            return data.toFixed(2) + " 元";
          }},
          {data: "status", defaultContent: ''},
          {data: "submitBy", defaultContent: ''},
          {data: "submitTime", defaultContent: '',render: function ( data, type, full, meta ) {
            var b = moment(new Date(data));
            var date = "";
            if (data != null) {
              date = b.format("YYYY/MM/DD HH:mm:ss");
            }
            return date;
          }},
          {data: ""}
        ]
      });
    });

    function audit(id, status){
      if (status == 1) {
        bootbox.alert("该申请已经通过!");
        return;
      }
      $("#priceAuditForm #ids").val(id);
        if (id) {
          bootbox.confirm("是否对该数据进行审核?", function (result) {
            if (result) {
              $("#priceAuditForm").submit();
            }
          });
      }
    }

    function refuse(id, status){
      if (status == 2){
        bootbox.alert("该申请已经被拒绝!");
        return;
      }
      $("#refuseModal #id").val(id);
      $("#refuseModal").modal('show');
    }

