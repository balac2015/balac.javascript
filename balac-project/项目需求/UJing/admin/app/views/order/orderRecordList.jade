//
   Created by yu869 on 2015/10/27.

extends ../layouts/vendor
block header
  link( rel="stylesheet" href="/plugins/datatables/dataTables.bootstrap.css")
  link(rel='stylesheet', href='/plugins/jBootstrapPage/jBootsrapPage.css')


//应用的page title
block pageTitle
  if today != null
    h1 加盟商查看今日订单记录
      small 查看今日订单记录和明细
  if today == null
    h1 加盟商查看全部订单记录
      small 查看全部订单记录和明细
block main
  .box.box-primary
    .box-header.with-border
      h3.box-title 订单记录
      form#cancelOrder(method='post', style='display:none', action='/order/cancelOrder')
        input#ids(type='hidden',name='ids')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
      form#shutdown(method='post', style='display:none', action='/device/shutdown')
        input#ids(type='hidden',name='ids')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
      form#orderRecordForm.form-horizontal(name="orderRecordForm" action='/order/orderRecord',method='post')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
        input#today.from-control.input-sm.col-sm-12(type='hidden',name='today',value='#{today}')
        input#num.from-control.input-sm.col-sm-12(type='hidden',name='num',value='#{page.num}')
        div.row.form-group
          label.control-label.col-sm-3
            | 订单编号：
          div.col-sm-8
            input#orderNo.from-control.input-sm.col-sm-12(type='text',name='orderNo',value='#{orderNo}')
        div.row.form-group
          label.control-label.col-sm-3
            | 订单状态：
          div.col-sm-8
            input#statu.from-control.input-sm.col-sm-12(type='hidden',name='statu',value='#{status}')
            select#status.from-control.input-sm.col-sm-9(name='status')
              option(value='') --请选择--
            | &nbsp;
            button#search.btn.btn-primary.btn-sm.col-sm-2(title='搜索')
              i.fa.fa-search

    .panel-body
      div.row
        div.col-md-12
        if orders!=null
          each v,i in orders
            div.box.box-primary
              div.box-header
                div.caption
                  i.fa.fa-indent
                  a(href="/order/orderDetail?orderId=#{v._id}")
                    span #{v.orderNo}
                  .box-tools.pull-right
                    a.btn.btn-xs.btn-info(href='/order/orderDetail?orderId=#{v._id}',title='明细')
                      i.fa.fa-search-plus
            div.portlet-body.form
              div#orders.well
                ul
                  li 订&nbsp;&nbsp;单&nbsp;&nbsp;号 : #{v.orderNo}
                  li 微信用户 : #{v.wechatFansId == null ?"" : v.wechatFansId.nickname}
                  li 洗衣店 : #{v.storeId == null ? "" : v.storeId.name}
                  li 加盟商 : #{v.franchiseeId == null ? "" : v.franchiseeId.fullname}
                  li 设备编号 : #{v.deviceId.no}
                  li 支付金额 : #{v.allowance.toFixed(2)}
                  li 业务状态 : #{v.status == '10' ? '预约' : v.status == '20'?'已支付' : v.status == '21' ? '桶自洁中' : v.status == '22' ? '桶自洁完成' : v.status == '30' ? '使用中' : v.status == '40' ? '完成' : v.status == '50'?'撤销':'退款'}
                  li 开始时间 : #{v.useTime == null ? "" : formatDatetime(v.useTime)}
                  li 结束时间 : #{v.endTime == null ? "" : formatDatetime(v.endTime)}
                  if ((new Date(v.createAt).valueOf() - (new Date().valueOf() - 259200000)) > 0 && v.status == "30")
                    li
                      a(href="#" onclick="cancelOrder('#{v._id}')") 取消订单
                  if (v.deviceId.status == '2')
                    li
                      a(href="#" onclick="shutdown('#{v.deviceId._id}')") 关机


        ul.pager.text-left
          li
            if page.num == 1
              bubutton.previous.btn.btn-sm.disabled(title='不可用')
                span &larr;上一页
            if page.num != 1
              bubutton#previous.previous.btn.btn-sm.btn-primary(title='上一页')
                span &larr;上一页
          li
            if page.num >= page.pageCount
              bubutton.next.btn.btn-sm.disabled(title='不可用')
                span 下一页&rarr;
            if page.num < page.pageCount
              bubutton#next.next.btn.btn-sm.btn-primary(title='下一页')
                span 下一页&rarr;
        div.col-md-12.text-center
          span.control-label.col-md-12 第#{page.pageCount == 0?0:page.num}页，共#{page.pageCount}页，共#{page.count}条订单


block scripts
  script.
    $(document).ready(function () {
      $('#status').ready(function(e) {
        $.ajax({
          type: "get",
          url: "/order/getAllStatus",
          data: {},
          success: function (data) {
            var s=$('#statu').val();
            $.each(data, function (i, item) {
                var ui = '';
                if(item.code==s){
                  ui = "<option value='" + item.code + "' selected='default'>" + item.name + "</option>"
                }else {
                  ui = "<option value='" + item.code + "'>" + item.name + "</option>"
                }
                $("select[name='status']").append(ui);
            })
          }
        });
      });
      $("#search").on('click', function () {
        $("#num").val(1);
        $("#orderRecordForm").submit();
      });
      $("#previous").on('click', function () {
        var num=$("#num").val();
        $("#num").val(num-1);
        $("#orderRecordForm").submit();
      });
      $("#next").on('click', function () {
        var num=$("#num").val();
        $("#num").val(++num);
        $("#orderRecordForm").submit();
      });
    });

    function cancelOrder(orderId) {
      $("#cancelOrder #ids").val(orderId);
      bootbox.confirm("确定要取消订单吗?", function(result) {
        if (result) {
          $("#cancelOrder").submit();
        }
      });
    }

    function shutdown(deviceId) {
      $("#shutdown #ids").val(deviceId);
      bootbox.confirm("确定要关机么?", function(result) {
        if (result) {
          $("#shutdown").submit();
        }
      });
    }